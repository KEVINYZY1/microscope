<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.vipshop.microscope.mysql.dao.TraceReportDao">

	<resultMap id="traceReportList" type="TraceReport">
		<result column="year" property="year" />
		<result column="month" property="month" />
		<result column="week" property="week" />
		<result column="day" property="day" />
		<result column="hour" property="hour" />
		<result column="app" property="app" />
		<result column="ip_adress" property="ipAdress" />
		<result column="type" property="type" />
		<result column="name" property="name" />
		<result column="total_count" property="totalCount" />
		<result column="failure_count" property="failureCount" />
		<result column="failure_precent" property="failurePrecent" />
		<result column="min" property="min" />
		<result column="max" property="max" />
		<result column="sum" property="sum" />
		<result column="avg" property="avg" />
		<result column="tps" property="tps" />
		<result column="start_time" property="startTime" />
		<result column="end_time" property="endTime" />
		<result column="region_0" property="region_0" />
		<result column="region_1" property="region_1" />
		<result column="region_2" property="region_2" />
		<result column="region_3" property="region_3" />
		<result column="region_4" property="region_4" />
		<result column="region_5" property="region_5" />
		<result column="region_6" property="region_6" />
		<result column="region_7" property="region_7" />
		<result column="region_8" property="region_8" />
		<result column="region_9" property="region_9" />
		<result column="region_10" property="region_10" />
		<result column="region_11" property="region_11" />
		<result column="region_12" property="region_12" />
		<result column="region_13" property="region_13" />
		<result column="region_14" property="region_14" />
		<result column="region_15" property="region_15" />
		<result column="region_16" property="region_16" />
	</resultMap>

	<select id="countAll" resultType="int">
		select count(*) from trace_stat_report;
	</select>
	
	<delete id="emptyTraceReport">
		DELETE FROM trace_stat_report;
	</delete>
	
	<insert id="saveTraceReport" parameterType="TraceReport">
		insert into trace_stat_report
		(year, month, week, day, hour, app, ip_adress, type, name, total_count, failure_count, failure_precent, 
		 min, max, sum, avg, tps, start_time, end_time,
		 region_0, region_1, region_2, region_3, region_4, region_5, region_6, region_7, region_8, region_9, 
		 region_10, region_11, region_12, region_13, region_14, region_15, region_16)
		values
		(#{year},#{month},#{week},#{day},#{hour},#{app},#{ipAdress},#{type},#{name},#{totalCount},#{failureCount},#{failurePrecent},
		 #{min},#{max},#{sum},#{avg},#{tps},#{startTime},#{endTime},
		 #{region_0},#{region_1},#{region_2},#{region_3},#{region_4},#{region_5},#{region_6},#{region_7},#{region_8},#{region_9},
		 #{region_10},#{region_11},#{region_12},#{region_13},#{region_14},#{region_15},#{region_16})
	</insert>
	
	<select id="findTraceReport" parameterType="TraceReportCondition"
		resultMap="traceReportList">
		SELECT year, month, day, week, day, hour, 
		app, type, name, SUM(total_count) AS total_count, SUM(failure_count) AS failure_count, TRUNCATE(failure_count/total_count, 3) as failure_precent,
		MIN(MIN) AS MIN, MAX(MAX) AS MAX, AVG(AVG) AS AVG, SUM(sum) as sum, TRUNCATE(total_count/((MAX(end_time) - MIN(start_time)) / 1000), 3) AS tps, start_time, end_time,
		SUM(region_0) as region_0, SUM(region_1) as region_1, SUM(region_2) as region_2, SUM(region_3) as region_3, SUM(region_4) as region_4, SUM(region_5) as region_5,
		SUM(region_6) as region_6, SUM(region_7) as region_7, SUM(region_8) as region_8, SUM(region_9) as region_9, SUM(region_10) as region_10, SUM(region_11) as region_11,
		SUM(region_12) as region_12, SUM(region_13) as region_13, SUM(region_14) as region_14, SUM(region_15) as region_15, SUM(region_16) as region_16
		From trace_stat_report
		WHERE app = #{appName}
		<if test="type != null"> and type = #{type} </if>
		<if test="name != null"> and name like ${name} </if>
		<if test="year != -1"> and year = #{year} </if>
		<if test="month != -1"> and month = #{month} </if>
		<if test="day != -1"> and day = #{day} </if>
		<if test="hour != -1"> and hour = #{hour} </if>
		
		<if test="groupBy == 'type'"> GROUP BY type </if>
		<if test="groupBy == 'name'"> GROUP BY name </if>
	</select>
	
	<insert id="saveOverTimeReport" parameterType="OverTimeReport">
		insert into trace_overtime_report
		(year, month, week, day, hour, minute, app, ip_adress, type, name, avg_dura, hit_count, fail_count)
		values
		(#{year},#{month},#{week},#{day},#{hour},#{minute},#{app},#{ipAdress},#{type},#{name},#{avgDura},#{hitCount},#{failCount})
	</insert>
	
	<delete id="emptyOverTimeReport">
		DELETE FROM trace_overtime_report;
	</delete>
	

</mapper>