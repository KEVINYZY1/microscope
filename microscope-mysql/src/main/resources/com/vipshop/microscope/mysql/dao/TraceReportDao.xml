<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.vipshop.microscope.mysql.dao.TraceReportDao">

	<resultMap id="traceReportList" type="TraceReport">
		<result column="year" property="year" />
		<result column="month" property="month" />
		<result column="week" property="week" />
		<result column="day" property="day" />
		<result column="hour" property="hour" />
		<result column="app" property="app" />
		<result column="ip_adress" property="ipAdress" />
		<result column="type" property="type" />
		<result column="name" property="name" />
		<result column="total_count" property="totalCount" />
		<result column="failure_count" property="failureCount" />
		<result column="failure_precent" property="failurePrecent" />
		<result column="min" property="min" />
		<result column="max" property="max" />
		<result column="sum" property="sum" />
		<result column="avg" property="avg" />
		<result column="tps" property="tps" />
		<result column="start_time" property="startTime" />
		<result column="end_time" property="endTime" />
	</resultMap>

	<select id="countAll" resultType="int">
		select count(*) from trace_report;
	</select>
	
	<delete id="emptyTraceReport">
		DELETE FROM trace_report;
	</delete>
	
	<insert id="saveTraceReport" parameterType="TraceReport">
		insert into trace_report
		(year, month, week, day, hour, app, ip_adress, type, name, total_count, failure_count, failure_precent, min, max, sum, avg, tps, start_time, end_time)
		values
		(#{year},#{month},#{week},#{day},#{hour},#{app},#{ipAdress},#{type},#{name},#{totalCount},#{failureCount},#{failurePrecent},#{min},#{max},#{sum},#{avg},#{tps},#{startTime},#{endTime})
	</insert>
	
	<select id="findTraceReportByApp" parameterType="TraceReportCondition"
		resultMap="traceReportList">
		SELECT app, type, name, SUM(total_count) AS total_count, SUM(failure_count) AS failure_count, TRUNCATE(failure_count/total_count, 3) as failure_precent,
		MIN(MIN) AS MIN, MAX(MAX) AS MAX, AVG(AVG) AS AVG, SUM(sum) as sum, TRUNCATE(total_count/((MAX(end_time) - MIN(start_time)) / 1000), 3) AS tps, start_time, end_time
		From trace_report
		WHERE app = #{appName}
		GROUP BY app;
	</select>
	
	<insert id="saveDurationDistReport" parameterType="DurationDistReport">
		insert into duration_dist_report
		(year, month, week, day, hour, app, ip_adress, type, name, region_0, region_1, region_2, region_3, region_4, region_5, region_6, region_7, region_8, region_9, region_10, region_11, region_12, region_13, region_14, region_15, region_16)
		values
		(#{year},#{month},#{week},#{day},#{hour},#{app},#{ipAdress},#{type},#{name},#{region_0},#{region_1},#{region_2},#{region_3},#{region_4},#{region_5},#{region_6},#{region_7},#{region_8},#{region_9},#{region_10},#{region_11},#{region_12},#{region_13},#{region_14},#{region_15},#{region_16})
	</insert>
	
	<delete id="emptyDurationDist">
		DELETE FROM duration_dist_report;
	</delete>
	
	<insert id="saveOverTimeReport" parameterType="OverTimeReport">
		insert into over_time_report
		(year, month, week, day, hour, minute, app, ip_adress, type, name, avg_dura, hit_count, fail_count)
		values
		(#{year},#{month},#{week},#{day},#{hour},#{minute},#{app},#{ipAdress},#{type},#{name},#{avgDura},#{hitCount},#{failCount})
	</insert>
	
	<delete id="emptyOverTimeReport">
		DELETE FROM over_time_report;
	</delete>
	

</mapper>