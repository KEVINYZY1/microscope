<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.vipshop.microscope.mysql.dao.SourceReportDao">
	
	<resultMap id="sourceReportList" type="SourceReport">
		<result column="app" property="app" />
		<result column="name" property="name" />
		<result column="count" property="count" />
		<result column="hour" property="hour" />
		<result column="server_type" property="serverType" />
		<result column="server_ip" property="serverIp" />
		<result column="sql_type" property="sqlType" />
		<result column="fail" property="fail" />
		<result column="failpre" property="failpre" />
		<result column="avg_dura" property="avgDura" />
		<result column="tps" property="tps" />
	</resultMap>
	
	<insert id="saveSourceReport" parameterType="SourceReport">
		insert into source_report
		(year, month, week, day, hour, app, name, server_type, server_ip, sql_type, count, fail, failpre, start_time, end_time, avg_dura, tps)
		values
		(#{year},#{month},#{week},#{day},#{hour},#{app},#{name},#{serverType},#{serverIp},#{sqlType},#{count},#{fail},#{failpre},#{startTime},#{endTime},#{avgDura},#{tps})
	</insert>
	
	<select id="findSourceReport" parameterType="SourceReportCondition" resultMap="sourceReportList">
		select app, count, hour
		from source_report
		where
		<if test="serverType != null"> server_type = #{serverType} </if>
		<if test="serverIp != null"> and server_ip = #{serverIp} </if>
		<if test="year != -1"> and year = #{year} </if>
		<if test="month != -1"> and month = #{month} </if>
		<if test="week != -1"> and week = #{week} </if>
		<if test="day != -1"> and day = #{day} </if>
		group by app, hour
	</select>
	
	<select id="findSourceReportDist" parameterType="SourceReportCondition" resultMap="sourceReportList">
		select app, SUM(count) as count
		from source_report
		where
		<if test="serverType != null"> server_type = #{serverType} </if>
		<if test="serverIp != null"> and server_ip = #{serverIp} </if>
		<if test="year != -1"> and year = #{year} </if>
		<if test="month != -1"> and month = #{month} </if>
		<if test="week != -1"> and week = #{week} </if>
		<if test="day != -1"> and day = #{day} </if>
		group by app
	</select>
	
	<select id="findSourceReportTOP" parameterType="SourceReportCondition" resultMap="sourceReportList">
		select app, SUM(COUNT) AS COUNT, SUM(fail) AS fail,  AVG(failpre) AS failpre, sql_type, AVG(avg_dura) AS avg_dura, AVG(tps) AS tps
		from source_report
		where
		<if test="serverType != null"> server_type = #{serverType} </if>
		<if test="serverIp != null"> and server_ip = #{serverIp} </if>
		<if test="year != -1"> and year = #{year} </if>
		<if test="month != -1"> and month = #{month} </if>
		<if test="week != -1"> and week = #{week} </if>
		<if test="day != -1"> and day = #{day} </if>
		GROUP BY app
		ORDER BY COUNT DESC
	</select>
	
</mapper>